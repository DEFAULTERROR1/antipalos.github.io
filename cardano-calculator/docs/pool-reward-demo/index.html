<html>
    <head>

        <title>
            Cardano Pool Rewards distribution demo
        </title>

        <script src="../../assets/js/vendor/jquery/jquery.min.js"></script>
        <script src="../../assets/js/hashtabs.js"></script>
        <script src="../../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>

        <link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">

        <style type="text/css">
            body {
                padding-top: 5rem;
            }

            .chart-canvas {
                width: 50%;
            }
            p, div.alert {
                width: 60%;
            }

            @media (max-width: 1023.99px) {
                .chart-canvas {
                    width: 75%;
                }
                p, div.alert {
                    width: 80%;
                }
            }

            @media (max-width: 767.99px) {
                .chart-canvas {
                    width: 100%;
                }
                p, div.alert {
                    width: 100%;
                }
            }
        </style>

        <script language="JavaScript">

            const PARAMS = {
                k: 100,
                a0: 0.25,
                o: 0.01,
                s: 0.01,
                R: 100
            };

            const FLOATS = ['a0', 'o', 's'];

            const COLORS = {
                black: 'rgb(0, 0, 0)',
                red: 'rgb(255, 99, 132)',
                orange: 'rgb(255, 159, 64)',
                aqua: 'rgb(0, 255, 255)',
                yellow: 'rgb(255, 205, 86)',
                green: 'rgb(75, 192, 192)',
                brown: 'rgb(165, 42, 42)',
                blue: 'rgb(54, 162, 235)',
                purple: 'rgb(153, 102, 255)',
                grey: 'rgb(201, 203, 207)',
                cadet: 'rgb(95, 158, 160)'
            };
            const COLOR_ARR = Object.values(COLORS);

            const STEPS_O_S = Object.freeze([0.0, 0.0025, 0.005, 0.0075, 0.01, 0.015, 0.02]);
            const STEPS_A0 = Object.freeze([0.0, 0.1, 0.25, 0.5, 1, 3, 5, 10]);

            $(function() {

                Object.entries(PARAMS).forEach(function ([k, v]) {
                    $('#' + k).val(v);
                });

                $('input').on("change paste keyup", function () {
                    $this = $(this);
                    let id = $this.attr('id');
                    let val = $this.val() || '0';
                    PARAMS[id] = FLOATS.indexOf(id) > -1 ? parseFloat(val) : parseInt(val);
                    update(PARAMS);
                    updateView(PARAMS);
                });

                update(PARAMS);
                updateView(PARAMS);

                HashTabs.bind({scrollToTop: false});
            });

            function round(val) {
                return Number(Math.round(val+'e11')+'e-11');
            }

            function update(params = PARAMS) {
                params.z0 = round(1/params.k);
                params.oP = round(Math.min(params.o, params.z0));
                params.sP = round(Math.min(params.s, params.z0));
                params.A = round((params.z0 - params.oP) / params.z0);
                params.B = round(params.sP * params.A);
                params.C = round(params.oP - params.B);
                params.D = round(params.C / params.z0);
                params.E = round(params.sP * params.a0 * params.D);
                params.F = round(params.oP + params.E);
                params.G = round(params.R / (1 + params.a0));
                params.H = round(params.G * params.F);
                return params;
            }

            function updateView(params) {
                $('span.result').each(function () {
                    $this = $(this);
                    $this.text(params[$this.attr('id')]);
                });
                drawCharts(params);
            }

            function drawCharts(params) {

                if (window.chart) {
                    window.chart.forEach((c) => c.destroy());
                }

                window.chart = [
                    draw_sH_chart('chart-s_H', params),
                    draw_oH_chart('chart-o_H', params),
                    draw_aoH_chart('chart-a_o_H', params),
                    draw_asH_chart('chart-a_s_H', params),
                ]
            }

            function draw_sH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_O_S,
                    yName: 'o',
                    xName: 's',
                    title: 'Changing of result (H) in dependence to o and s (a0 = ' + params.a0 + ')'
                });
            }

            function draw_oH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_O_S,
                    yName: 's',
                    xName: 'o',
                    title: 'Changing of result (H) in dependence to o and s (a0 = ' + params.a0 + ')'
                });
            }

            function draw_aoH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_A0,
                    yName: 'o',
                    xName: 'a0',
                    title: 'Changing of result (H) in dependence to a0 and o (s = ' + params.s + ')'
                });
            }

            function draw_asH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_A0,
                    yName: 's',
                    xName: 'a0',
                    title: 'Changing of result (H) in dependence to a0 and s (o = ' + params.o + ')'
                });
            }

            function plotDataAndCreateChart(canvasId, params,
                    {ySteps = [], xSteps = [], yName = '', xName = '', title = ''} = {}) {
                return createChart(canvasId, {
                    title: title,
                    xName: xName,
                    labels: xSteps,
                    datasets: createDatasetFromSteps(params, ySteps, xSteps, yName, (y,x) => {
                        let r = {};
                        r[yName] = y;
                        r[xName] = x;
                        return r;
                    })
                });
            }

            function createDatasetFromSteps(params, ySteps, xSteps, yLabel, f) {
                return ySteps.map(function (y, idx) {
                    return {
                        label: yLabel + ' = ' + y,
                        fill: false,
                        borderColor: COLOR_ARR[idx],
                        backgroundColor: COLOR_ARR[idx],
                        data: xSteps.map(function (x) {
                            return update(Object.assign(Object.create(params), f(y, x))).H;
                        })
                    };
                });
            }

            function createChart(canvasId, {labels = [], datasets = [], xName = '', title = ''} = {}) {
                let ctx = document.getElementById(canvasId).getContext('2d');
                return Chart.Line(ctx, {
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        title: {
                            display: true,
                            text: title
                        },
                        animation: {
                            duration: 0
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: xName
                                }
                            }],
                            yAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'H'
                                }
                            }]
                        }
                    }
                });
            }

            </script>
    </head>
    <body>

        <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top border-bottom">
            <span class="navbar-brand"><a href="../..">Cardano Calculator</a> / <a href="..">Docs</a> / Pool reward demo</span>

            <button class="navbar-toggler my-2" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">

                <ul class="nav nav-pills nav-fill ml-auto" id="pills-tab" role="tablist">

                    <li class="nav-item">
                        <a class="nav-link hashtab active" id="formula-tab" data-toggle="tab" href="#formula" role="tab" aria-controls="formula" aria-selected="true">Formula</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link hashtab" id="faq-tab" data-toggle="tab" href="#charts" role="tab" aria-controls="faq" aria-selected="false">o/s charts</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link hashtab" id="roadmap-tab" data-toggle="tab" href="#charts2" role="tab" aria-controls="roadmap" aria-selected="false">a0 charts</a>
                    </li>

                </ul>

            </div>
        </nav>

        <div class="container-fluid">

            <img src="pool_reward.png">

            <h3>Parameters</h3>
            <div class="container">
                <div class="row">
                    <label class="col-sm form-group form-control">
                        <span>o: </span><input id="o" type="number" min="0" step="0.001"><span class="text-nowrap"> (pool share)</span>
                    </label>
                    <label class="col-sm form-group form-control">
                        <span>k: </span><input id="k" type="number" min="1" step="1"><span class="text-nowrap"> (desired number of pools)</span>
                    </label>
                </div>
                <div class="row">
                    <label class="col-sm form-group form-control">
                        <span>s: </span><input id="s" type="number" min="0" step="0.001"><span class="text-nowrap"> (leader share)</span>
                    </label>
                    <label class="col-sm form-group form-control">
                        <span>a0: </span><input id="a0" type="number" min="0" step="0.05"><span class="text-nowrap"> (leader stake influence)</span>
                    </label>
                </div>
                <div class="row">
                    <span class="col-sm"></span>
                    <label class="col-sm form-group form-control">
                        <span>R: </span><input id="R" type="number" min="0" step="1"><span class="text-nowrap"> (total epoch reward)</span>
                    </label>
                </div>
            </div>

            <div class="tab-content">

                <div id="formula" class="tab-pane active">

                    <h3 class="pt-2">Formula break-down</h3>

                    <div class="row">
                        <div class="col-sm border">
                            <span class="text-nowrap">z0 [1/k] = <span class="result" id="z0">?</span> (max cap share)</span><br/>
                            <span class="text-nowrap">o' [min(o,z0)] = <span class="result" id="oP">?</span> (capped pool share)</span><br/>
                            <span class="text-nowrap">s' [min(s,z0)] = <span class="result" id="sP">?</span> (capped leader share)</span><br/>
                            <br/>
                        </div>
                        <div class="col-sm border">
                            <span class="text-nowrap">A [(z0 - o') / z0] = <span class="result" id="A">?</span></span><br/>
                            <span class="text-nowrap">B [s' * A] = <span class="result" id="B">?</span></span><br/>
                            <span class="text-nowrap">C [o' - B] = <span class="result" id="C">?</span></span><br/>
                            <span class="text-nowrap">D [C / z0] = <span class="result" id="D">?</span></span><br/>
                            <span class="text-nowrap">E [s' * a0 * D] = <span class="result" id="E">?</span></span><br/>
                            <span class="text-nowrap">F [o' + E] = <span class="result" id="F">?</span></span><br/>
                            <br/>
                        </div>
                        <div class="col-sm border">
                            <span class="text-nowrap">G [R / (1 + a0)] = <span class="result" id="G">?</span></span><br/>
                            <span class="text-nowrap">H [G * F] = <span class="result" id="H">?</span> (final result)</span><br/>
                        </div>
                    </div>

                    <h3 class="pt-2">Explanation</h3>

                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h5>Warning!</h5>
                                <p style="width: 100%">
                                    <span class="alert-warning">This demo-page  is NOT a reward calculator!</span><br/>
                                    You should NOT use this page to try and predict your staking profits!
                                    The ONLY purpose of this demo is to show the effect of <code>o</code>, <code>s</code>,
                                    and <code>a0</code> parameters on the reward distribution process.
                                </p>
                            </div>
                            <p>
                                Cardano staking rewards distribution happens once at the end of each epoch (5 days).
                                For 5 days all the rewards in the system are collected in a special address.
                                At the end of an epoch total reward pool <code>(R)</code> is split between
                                all the participants and the treasury.
                                This formula is just a single part of the complex system, and it determines how
                                delegated pool stake <code>(o)</code> and personal pool-leader stake <code>(s)</code>
                                affect the reward distribution among pools.
                            </p>

                            <h4>Parameters description</h4>
                            <p>
                                "Desired number of pools" <code>(k)</code> - this is a system constant that is expected to
                                be around 100. This parameter shows what <b>optimal</b> number of pools is expected to be
                                in the system; at least 80% of total stake is expected to be controlled by this number of pools.
                                The stake share cap value <code>(z0)</code> is calculated from this parameter and this value
                                determines what is the <b>maximum</b> reward any single node can ever get. Basically,
                                if a node (pool) stake share is bigger then <code>z0</code> - then it is calculated as
                                if its share was <code>z0</code>. The point of this is to make sure that system does not
                                settles at the number of pools lower than <code>k</code> - because if this happens,
                                then it would mean that people just miss additional possible profits that they can get
                                if someone creates new pools. There might and will be more than <code>k</code> pools,
                                but there shouldn't be less.
                            </p>
                            <p>
                                "Pool share" <code>(o)</code> - the share of all the stake delegated to this pool,
                                relative to ALL the stake in the system. If the system has current total stake of 10 billion ADA,
                                and the pool has 50 million ADA of delegated stake than it's share is <code>0.5%</code> or
                                <code>0.005</code>. Maximum <b>meaningful</b> value of <code>o</code> is <code>z0</code>
                                which depends on <code>k</code>. So if the desired number of pools is 100, then maximum
                                <b>meaningful</b> <code>o</code> is <code>0.01</code>. Any share, bigger than this, will
                                <b>NOT</b> bring more rewards. Pool share directly determines how likely the pool is to be
                                selected to produce a block for each slot in an epoch. The bigger the pool share - the more
                                slots it will win, and the larger total reward it will get. But it will <b>NEVER</b> get more than
                                <code>z0</code> share of the total reward.
                            </p>
                            <p>
                                "Leader share" <code>(s)</code> - the share of stake that pool-leader (creator) has
                                <b>pledged</b> to this pool. Creator of the pool will need to "lock" <b>at least</b>
                                this amount of stake (or more) in order for pool to be selected at all. The size of this
                                pledge will also determine the overall size of pool rewards. Maximum <b>significant</b> value
                                for the pledge is also <code>z0</code>. Only a pool with a maximum pledge will be able to
                                receive the maximum delegation reward. As pledge gets lower - reward also gets logarithmically
                                lower even for the same delegated stake share. This pledge is required to eliminate the
                                possibility for an adversary to create fake popular pools.
                            </p>
                            <p>
                                "Leader stake influence" <code>(a0)</code> - this is a system constant, and its value
                                is yet to be decided. The bigger this value gets - the harder it is for an adversary
                                to create enough pools to gain the majority control. BUT! At the same time the difference
                                in profits between differently funded pools also gets bigger.
                            </p>
                            <p>
                                "Total epoch reward" <code>(R)</code> - represents the pool of total reward for the whole epoch.
                                Similar pool of coins gets distributed among all the participant nodes at the end of each epoch.
                                Exact value of this parameter is not important for this demo and will affect only chart scales.
                                It is just randomly taken at 100 ADA so that charts would not look like promising some real numbers.
                            </p>
                            <div class="border-top pt-2">
                                <h5>Sources</h5>
                                <p>
                                    This formula is taken from the official delegation spec DRAFT:
                                    <a href="..">Calculator Documentation</a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="charts" class="tab-pane">

                    <h3 class="pt-2">Pool stake to leader stake charts</h3>

                    <div class="row d-flex justify-content-around">
                        <div class="chart-canvas border">
                            <canvas id="chart-s_H"></canvas>
                        </div>
                        <div class="chart-canvas border">
                            <canvas id="chart-o_H"></canvas>
                        </div>
                    </div>

                    <h3 class="pt-2">Explanation</h3>
                    <div class="row">
                        <div class="col-12">
                            <p>
                                These two charts show how resulting pool reward is affected by changing
                                <code>o</code> and <code>s</code> values.
                            </p>
                        </div>
                    </div>
                </div>

                <div id="charts2" class="tab-pane">

                    <h3 class="pt-2">Leader stake influence charts</h3>

                    <div class="row d-flex justify-content-around">
                        <div class="chart-canvas border">
                            <canvas id="chart-a_o_H"></canvas>
                        </div>
                        <div class="chart-canvas border">
                            <canvas id="chart-a_s_H"></canvas>
                        </div>
                    </div>

                    <h3 class="pt-2">Explanation</h3>
                    <div class="row">
                        <div class="col-12">
                            <p>
                                These two charts show how resulting pool reward is affected by increasing the
                                <code>a0</code> value with different <code>o</code> and <code>s</code> values.
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <br/>
            <br/>

            <div class="row">
                <div class="col-md-12">
                    <div id="footer" class="text-center">
                        GitHub <a target="_blank" href="https://github.com/antipalos/antipalos.github.io/issues?q=is%3Aopen+is%3Aissue+project%3Aantipalos%2Fantipalos.github.io%2F1">@Antipalos</a>
                        | Dev: <a target="_blank" href="https://twitter.com/vsubhuman">@vsubhuman</a>
                        | Forum: <a target="_blank" href="https://forum.cardano.org/t/cardano-staking-profits-calculator/12314">forum.cardano.org</a>
                        | Chat: <a target="_blank" href="https://t.me/CardanoGeneral">t.me/CardanoGeneral</a>
                        | Reddit: <a target="_blank" href="https://www.reddit.com/r/cardano/comments/8m0ji3/cardano_staking_profits_calculator/">r/Cardano</a>
                        | Donate: <a target="_blank" href="https://cardanowiki.info/wiki/Funding">CardanoWiki</a>
                    </div>
                </div>
            </div>

        </div>

    </body>
</html>
