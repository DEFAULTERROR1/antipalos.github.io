<html>
    <head>

        <script src="../assets/js/vendor/jquery/jquery.min.js"></script>
        <script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>

        <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">

        <style type="text/css">
            .chart-canvas {
                width: 50%;
            }

            @media (max-width: 1023.99px) {
                .chart-canvas {
                    width: 75%;
                }
            }

            @media (max-width: 767.99px) {
                .chart-canvas {
                    width: 100%;
                }
            }
        </style>

        <script language="JavaScript">

            const PARAMS = {
                k: 100,
                a0: 0.25,
                o: 0.01,
                s: 0.01,
                R: 100000
            };

            const FLOATS = ['a0', 'o', 's'];

            const COLORS = {
                black: 'rgb(0, 0, 0)',
                red: 'rgb(255, 99, 132)',
                orange: 'rgb(255, 159, 64)',
                aqua: 'rgb(0, 255, 255)',
                yellow: 'rgb(255, 205, 86)',
                green: 'rgb(75, 192, 192)',
                brown: 'rgb(165, 42, 42)',
                blue: 'rgb(54, 162, 235)',
                purple: 'rgb(153, 102, 255)',
                grey: 'rgb(201, 203, 207)',
                cadet: 'rgb(95, 158, 160)'
            };
            const COLOR_ARR = Object.values(COLORS);

            const STEPS_O_S = Object.freeze([0.0, 0.0025, 0.005, 0.0075, 0.01, 0.015, 0.02]);
            const STEPS_A0 = Object.freeze([0.0, 0.1, 0.25, 0.5, 1, 3, 5, 10]);

            $(function() {

                Object.entries(PARAMS).forEach(function ([k, v]) {
                    $('#' + k).val(v);
                });

                $('input').on("change paste keyup", function () {
                    $this = $(this);
                    let id = $this.attr('id');
                    let val = $this.val() || '0';
                    PARAMS[id] = FLOATS.indexOf(id) > -1 ? parseFloat(val) : parseInt(val);
                    update(PARAMS);
                    updateView(PARAMS);
                });

                update(PARAMS);
                updateView(PARAMS);
            });

            function round(val) {
                return Number(Math.round(val+'e11')+'e-11');
            }

            function update(params = PARAMS) {
                params.z0 = round(1/params.k);
                params.oP = round(Math.min(params.o, params.z0));
                params.sP = round(Math.min(params.s, params.z0));
                params.A = round((params.z0 - params.oP) / params.z0);
                params.B = round(params.sP * params.A);
                params.C = round(params.oP - params.B);
                params.D = round(params.C / params.z0);
                params.E = round(params.sP * params.a0 * params.D);
                params.F = round(params.oP + params.E);
                params.G = round(params.R / (1 + params.a0));
                params.H = round(params.G * params.F);
                return params;
            }

            function updateView(params) {
                $('span.result').each(function () {
                    $this = $(this);
                    $this.text(params[$this.attr('id')]);
                });
                drawCharts(params);
            }

            function drawCharts(params) {

                if (window.chart) {
                    window.chart.forEach((c) => c.destroy());
                }

                window.chart = [
                    draw_sH_chart('chart-s_H', params),
                    draw_oH_chart('chart-o_H', params),
                    draw_aoH_chart('chart-a_o_H', params),
                    draw_asH_chart('chart-a_s_H', params),
                ]
            }

            function draw_sH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_O_S,
                    yName: 'o',
                    xName: 's',
                    title: 'Changing of result (H) in dependence to o and s (a0 = ' + params.a0 + ')'
                });
            }

            function draw_oH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_O_S,
                    yName: 's',
                    xName: 'o',
                    title: 'Changing of result (H) in dependence to o and s (a0 = ' + params.a0 + ')'
                });
            }

            function draw_aoH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_A0,
                    yName: 'o',
                    xName: 'a0',
                    title: 'Changing of result (H) in dependence to a0 and o (s = ' + params.s + ')'
                });
            }

            function draw_asH_chart(canvas_id, params) {
                return plotDataAndCreateChart(canvas_id, params, {
                    ySteps: STEPS_O_S,
                    xSteps: STEPS_A0,
                    yName: 's',
                    xName: 'a0',
                    title: 'Changing of result (H) in dependence to a0 and s (o = ' + params.o + ')'
                });
            }

            function plotDataAndCreateChart(canvasId, params,
                    {ySteps = [], xSteps = [], yName = '', xName = '', title = ''} = {}) {
                return createChart(canvasId, {
                    title: title,
                    xName: xName,
                    labels: xSteps,
                    datasets: createDatasetFromSteps(params, ySteps, xSteps, yName, (y,x) => {
                        let r = {};
                        r[yName] = y;
                        r[xName] = x;
                        return r;
                    })
                });
            }

            function createDatasetFromSteps(params, ySteps, xSteps, yLabel, f) {
                return ySteps.map(function (y, idx) {
                    return {
                        label: yLabel + ' = ' + y,
                        fill: false,
                        borderColor: COLOR_ARR[idx],
                        backgroundColor: COLOR_ARR[idx],
                        data: xSteps.map(function (x) {
                            return update(Object.assign(Object.create(params), f(y, x))).H;
                        })
                    };
                });
            }

            function createChart(canvasId, {labels = [], datasets = [], xName = '', title = ''} = {}) {
                let ctx = document.getElementById(canvasId).getContext('2d');
                return Chart.Line(ctx, {
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        title: {
                            display: true,
                            text: title
                        },
                        animation: {
                            duration: 0
                        },
                        scales: {
                            xAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: xName
                                }
                            }],
                            yAxes: [{
                                display: true,
                                scaleLabel: {
                                    display: true,
                                    labelString: 'H'
                                }
                            }]
                        }
                    }
                });
            }

            </script>
    </head>
    <body>

        <div class="container-fluid">

            <h2>Pool reward calculation example (per epoch)</h2>

            <img src="pool_reward.png">

            <h3>Parameters</h3>
            <div class="container">
                <div class="row">
                    <label class="col-sm form-group form-control">
                        <span>o: </span><input id="o" type="number" min="0" step="0.001"><span class="text-nowrap"> (pool share)</span>
                    </label>
                    <label class="col-sm form-group form-control">
                        <span>k: </span><input id="k" type="number" min="1" step="1"><span class="text-nowrap"> (desired number of pools)</span>
                    </label>
                </div>
                <div class="row">
                    <label class="col-sm form-group form-control">
                        <span>s: </span><input id="s" type="number" min="0" step="0.001"><span class="text-nowrap"> (leader share)</span>
                    </label>
                    <label class="col-sm form-group form-control">
                        <span>a0: </span><input id="a0" type="number" min="0" step="0.05"><span class="text-nowrap"> (leader stake influence)</span>
                    </label>
                </div>
                <div class="row">
                    <span class="col-sm"></span>
                    <label class="col-sm form-group form-control">
                        <span>R: </span><input id="R" type="number" min="0" step="1"><span class="text-nowrap"> (total epoch reward)</span>
                    </label>
                </div>
            </div>

            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#formula">Formula</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#charts"><code>o\s</code> charts</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#charts2"><code>a0</code> charts</a>
                </li>
            </ul>

            <div class="tab-content">

                <div id="formula" class="tab-pane active">

                    <h3 class="pt-2">Formula break-down</h3>

                    <div class="row">
                        <div class="col-sm border">
                            <span class="text-nowrap">z0 [1/k] = <span class="result" id="z0">?</span> (max cap share)</span><br/>
                            <span class="text-nowrap">o' [min(o,z0)] = <span class="result" id="oP">?</span> (capped pool share)</span><br/>
                            <span class="text-nowrap">s' [min(s,z0)] = <span class="result" id="sP">?</span> (capped leader share)</span><br/>
                            <br/>
                        </div>
                        <div class="col-sm border">
                            <span class="text-nowrap">A [(z0 - o') / z0] = <span class="result" id="A">?</span></span><br/>
                            <span class="text-nowrap">B [s' * A] = <span class="result" id="B">?</span></span><br/>
                            <span class="text-nowrap">C [o' - B] = <span class="result" id="C">?</span></span><br/>
                            <span class="text-nowrap">D [C / z0] = <span class="result" id="D">?</span></span><br/>
                            <span class="text-nowrap">E [s' * a0 * D] = <span class="result" id="E">?</span></span><br/>
                            <span class="text-nowrap">F [o' + E] = <span class="result" id="F">?</span></span><br/>
                            <br/>
                        </div>
                        <div class="col-sm border">
                            <span class="text-nowrap">G [R / (1 + a0)] = <span class="result" id="G">?</span></span><br/>
                            <span class="text-nowrap">H [G * F] = <span class="result" id="H">?</span> (final result)</span><br/>
                        </div>
                    </div>
                </div>

                <div id="charts" class="tab-pane">

                    <h3 class="pt-2">Pool stake to leader stake charts</h3>

                    <div class="row d-flex justify-content-around">
                        <div class="chart-canvas border">
                            <canvas id="chart-s_H"></canvas>
                        </div>
                        <div class="chart-canvas border">
                            <canvas id="chart-o_H"></canvas>
                        </div>
                    </div>
                </div>

                <div id="charts2" class="tab-pane">

                    <h3 class="pt-2">Leader stake influence charts</h3>

                    <div class="row d-flex justify-content-around">
                        <div class="chart-canvas border">
                            <canvas id="chart-a_o_H"></canvas>
                        </div>
                        <div class="chart-canvas border">
                            <canvas id="chart-a_s_H"></canvas>
                        </div>
                    </div>
                </div>
            </div>


            <br/>
            <br/>

        </div>

    </body>
</html>
